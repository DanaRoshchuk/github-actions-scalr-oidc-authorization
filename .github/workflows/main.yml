name: Test Scalr Integration

on:
  push:
    branches:
      - master

jobs:
  run-opentofu:
    runs-on: ubuntu-latest
    environment: development

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate GitHub Actions OIDC ID Token
        id: generate-oidc-token
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            $ACTIONS_ID_TOKEN_REQUEST_URL)

          OIDC_ID_TOKEN=$(echo $RESPONSE | jq -r '.value')
          echo "OIDC_ID_TOKEN=$OIDC_ID_TOKEN" >> $GITHUB_ENV

      - name: Exchange OIDC ID Token for Scalr Token
        id: exchange-token
        run: |
          SCALR_TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{"id_token": "'${{ env.OIDC_ID_TOKEN }}'"}' \
            "${{ secrets.SCALR_HOST }}/api/iacp/v3/service-accounts/impersonate" \
            | jq -r '.data.attributes.token')

          echo "SCALR_TOKEN=$SCALR_TOKEN" >> $GITHUB_ENV

      - name: Generate Terraform Credentials File
        run: |
          mkdir -p ~/.terraform.d
          cat <<EOF > ~/.terraform.d/credentials.tfrc.json
          {
            "credentials": {
              "${{ secrets.SCALR_HOST }}": {
                "token": "${{ env.SCALR_TOKEN }}"
              }
            }
          }
          EOF

      - name: Generate Override Configuration
        run: |
          cat <<EOF > override.tf
          terraform {
            backend "scalr" {
              hostname = "${{ secrets.SCALR_HOST }}"
            }
          }
          EOF
      - name: Install OpenTofu
        run: |
          # Define the OpenTofu version to install
          OPENTOFU_VERSION="1.8.8"

          # Download OpenTofu binary
          curl -Lo opentofu.zip "https://github.com/opentofu/opentofu/releases/download/v${OPENTOFU_VERSION}/opentofu_${OPENTOFU_VERSION}_linux_amd64.zip"

          # Unzip the binary
          sudo apt-get install -y unzip
          unzip opentofu.zip

          # Move the binary to a directory in PATH
          sudo mv opentofu /usr/local/bin/opentofu

          # Verify installation
          opentofu --version
      - name: Initialize and Run OpenTofu
        run: |
          opentofu init
          opentofu apply -auto-approve
